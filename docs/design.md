# バイナリ通信プロトコルパーサ設計ドキュメント

## 概要

本ドキュメントは、ユーザー定義のJSON形式プロトコル仕様に基づきバイナリ通信データを解析するエンジンの設計方針をまとめたものです。可変長フィールドや繰り返しブロック、構造内の動的参照に対応します。

## 主要概念

### プロトコル設定

プロトコル仕様は以下の要素で構成されます：

| 要素名 | 必須か | 説明 |
|--------|--------|------|
| `protocolName` | ❌ 任意 | プロトコルの識別名 |
| `structure` | ✅ 必須 | フィールド定義の配列 |

### フィールド構造

プロトコル仕様における各フィールドは、以下の属性を持ちます。

| フィールド名 | 必須か | 説明 |
|--------------|--------|------|
| `type`       | ✅ 必須 | データ型（例：`uint8`、`block`） |
| `name`       | ✅ 必須 | フィールドの名称 |
| `id`         | ⛔ 条件付き | 参照用識別子（以下参照） |
| `size`       | ⛔ 条件付き | バイト単位のデータサイズ（bytesタイプの場合必須） |

### `id` フィールドのルール

使いやすさと柔軟性のバランスを取るため、`id` フィールドは条件付きで必須とします。

| 条件 | `id` の必要性 | 理由 |
|------|--------------|------|
| 他のフィールドから参照される場合（例：`repeatById`） | ✅ 必須 | 参照に必要 |
| 単独フィールドで参照されない場合 | ❌ 任意 | 手書きの負担を軽減 |

### データ型定義

| 型名 | 説明 | バイト数 | 備考 |
|------|------|----------|------|
| uint8 | 符号なし8ビット整数 | 1 | 自動サイズ設定 |
| uint16 | 符号なし16ビット整数 | 2 | 自動サイズ設定 |
| bytes | バイト列 | size指定 | sizeパラメータ必須 |
| block | 複合構造体 | - | content配列で内部構造を定義 |

## ブロック構造

### ブロックタイプの概要

blockタイプは複数のフィールドをグループ化する複合構造体を定義します。以下の特徴があります：

- 内部構造を`content`配列で定義
- 任意の深さのネスト構造が可能
- 繰り返し設定との組み合わせが可能

### ブロックフィールドの属性

| 属性名 | 必須か | 説明 |
|--------|--------|------|
| `type` | ✅ 必須 | 常に`"block"`を指定 |
| `name` | ✅ 必須 | ブロックの名称 |
| `content` | ✅ 必須 | 内部フィールド定義の配列 |
| `repeat` | ❌ 任意 | 固定回数繰り返し |
| `repeatById` | ❌ 任意 | ID参照による可変回数繰り返し |

## 繰り返し構造

フィールドやブロックの繰り返しには2つの方式があります：

### 1. 固定回数繰り返し

```json
{
  "name": "センサー値",
  "type": "uint16",
  "repeat": 3
}
```

- `repeat`属性に数値を指定
- 指定回数分だけフィールドを繰り返し
- 繰り返されるフィールドには`name(1)`, `name(2)`のように連番が付加

### 2. ID参照による可変回数繰り返し

```json
{
  "id": "count",
  "name": "センサー数",
  "type": "uint8"
},
{
  "name": "センサー値",
  "type": "uint16",
  "repeatById": "count"
}
```

- `repeatById`属性に参照するフィールドのIDを指定
- 参照先フィールドの値に応じて繰り返し回数が決定
- 固定回数と同様に連番が付加

### ブロックでの繰り返し

ブロック構造でも両方の繰り返し方式が利用可能です：

```json
{
  "name": "センサーブロック",
  "type": "block",
  "repeatById": "count",
  "content": [
    {
      "name": "センサーID",
      "type": "uint8"
    },
    {
      "name": "値",
      "type": "uint16"
    }
  ]
}
```

## パース結果の構造

### 階層構造

パース結果は以下の要素からなるツリー構造で表現されます：

- ParsedData: パース結果のルート
  - ProtocolName: プロトコル名
  - RootFields: トップレベルのフィールド配列
    - Field: 各フィールドの情報
      - Id: 参照用ID
      - Name: フィールド名
      - HexStr: 16進数表現の値
      - Children: 子フィールド配列（ブロックの場合）

### フィールド値の表現

- 単一フィールド: バイト配列を16進数文字列に変換（例：`"FF"`）
- ブロックフィールド: 子フィールドの配列として保持
- 繰り返しフィールド: 名前に連番を付加して別フィールドとして展開

### 値の参照と変換

- `ParseToInt()`: uint8/uint16値を整数に変換
- `HexStr`: バイト配列を16進文字列に変換（例：`"FF"`）
- 値が存在しない場合は`"--"`を表示

## 設計方針まとめ

- フィールド名称は `name` 属性で指定
- `id` は参照が必要な場合のみ利用
- データ型に応じて適切なサイズを自動設定
- JSON仕様は手書きに優しい軽量な設計とする
- ブロック構造により複雑なデータ構造を表現可能
- 固定長・可変長の繰り返し構造をサポート

### 主要な変更履歴

- labelをnameに変更（表示用ラベルの概念を統合）
- プロトコル名による識別機能を追加
- データ型ごとの固定サイズを明確化
- ブロック型によるネスト構造の詳細化
- 繰り返し構造のパターンを整理
- パース結果の構造を体系化