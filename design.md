
# バイナリ通信プロトコルパーサ設計ドキュメント

## 概要

本ドキュメントは、ユーザー定義のJSON形式プロトコル仕様に基づきバイナリ通信データを解析するエンジンの設計方針をまとめたものです。可変長フィールドや繰り返しブロック、構造内の動的参照に対応します。

## 主要概念

### フィールド構造

プロトコル仕様における各フィールドは、以下の属性を持ちます。

| フィールド名 | 必須か | 説明 |
|--------------|--------|------|
| `type`       | ✅ 必須 | データ型（例：`uint8`、`block`） |
| `label`      | ❌ 任意 | 表示用名称 |
| `id`         | ⛔ 条件付き必須 | 参照用識別子（以下参照） |
| `visible`    | ❌ 任意 | UIに表示するか（デフォルトは true） |

### `id` フィールドのルール

使いやすさと柔軟性のバランスを取るため、`id` フィールドは条件付きで必須とします。

| 条件 | `id` の必要性 | 理由 |
|------|--------------|------|
| 他のフィールドから参照される場合（例：`repeat.from`） | ✅ 必須 | 参照に必要 |
| 単独フィールドで参照されない場合 | ❌ 任意 | 手書きの負担を軽減 |
| 将来エディタで自動生成される場合 | ✅ 現状任意、将来は自動 | エディタにより補完可能 |

### 例

```json
[
  {
    "label": "デバイスID",
    "type": "uint8"
  },
  {
    "id": "SensorCount",
    "label": "センサー数",
    "type": "uint8"
  },
  {
    "label": "センサーデータ",
    "type": "block",
    "repeat": { "type": "value", "from": "SensorCount" },
    "structure": [
      { "label": "値", "type": "uint16" }
    ]
  }
]
```

## 設計方針まとめ

- `id` は参照が必要な場合のみ利用する。
- 表示名は `label` で管理し任意とする。
- JSON仕様は手書きに優しい軽量な設計とする。
- 将来はエディタがID生成・検証を支援する。

## 今後の拡張予定

- JSONスキーマによる検証（任意の厳格モード）
- エディタによるID自動補完機能
- 条件付きブロックなどの複雑構造対応
